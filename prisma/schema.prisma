// Prisma schema for WeekendPlanner backend
// This is an initial, extensible data model aligned with docs in /docs.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------
// Enums
// ---------

/// Category scope for a category taxonomy
enum CategoryScope {
  PLACE
  EVENT
}

/// Basic price tier range used in filters
enum PriceTier {
  FREE
  CHEAP
  MODERATE
  EXPENSIVE
  ANY
}

/// Company types (with children, couple, solo, friends, colleagues)
enum CompanyType {
  KIDS
  COUPLE
  SOLO
  FRIENDS
  COLLEAGUES
}

/// Where is the item: indoor/outdoor or both
enum VenueType {
  INDOOR
  OUTDOOR
  ANY
}

/// Status for admin/partner moderation
enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

/// External source identifiers
enum SourceType {
  TICKETMASTER
  PREDICTHQ
  GEOAPIFY
  GOOGLE_PLACES
  FOURSQUARE
  MANUAL
  PARTNER
}

/// Types of ingestion/import jobs
enum ImportKind {
  CSV
  ICS
  API
}

// ---------
// Core: Accounts & Geography
// ---------

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile   Profile?
  plans     Plan[]
  favorites Favorite[]
  reviews   Review[]
}

/// User preferences used for personalization and defaults
model Profile {
  id            String       @id @default(cuid())
  userId        String       @unique
  cityId        String?
  homeLat       Decimal?     @db.Decimal(10, 7)
  homeLng       Decimal?     @db.Decimal(10, 7)
  budget        PriceTier?
  preferredMode CompanyType?
  tags          String[] // interests keywords
  preferences   Json? // arbitrary structured prefs (ages of kids, mobility, etc.)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user User  @relation(fields: [userId], references: [id])
  city City? @relation(fields: [cityId], references: [id])
}

model GeoRegion {
  id        String   @id @default(cuid())
  name      String
  code      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cities City[]
}

model City {
  id        String   @id @default(cuid())
  name      String
  country   String
  regionId  String?
  lat       Decimal  @db.Decimal(10, 7)
  lng       Decimal  @db.Decimal(10, 7)
  tz        String // IANA timezone
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  region   GeoRegion? @relation(fields: [regionId], references: [id])
  places   Place[]
  events   Event[]
  profiles Profile[]
  plans    Plan[]
  partners Partner[]

  @@index([name])
}

// ---------
// Catalog: Places & Events
// ---------

model PlaceCategory {
  id        String        @id @default(cuid())
  key       String        @unique
  title     String
  parentId  String?
  scope     CategoryScope @default(PLACE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  parent     PlaceCategory?    @relation("PlaceCategoryToParent", fields: [parentId], references: [id])
  children   PlaceCategory[]   @relation("PlaceCategoryToParent")
  places     PlaceToCategory[]
  placesMain Place[]
}

model EventCategory {
  id        String        @id @default(cuid())
  key       String        @unique
  title     String
  parentId  String?
  scope     CategoryScope @default(EVENT)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  parent     EventCategory?    @relation("EventCategoryToParent", fields: [parentId], references: [id])
  children   EventCategory[]   @relation("EventCategoryToParent")
  events     EventToCategory[]
  eventsMain Event[]
}

model Place {
  id                    String                 @id @default(cuid())
  cityId                String
  name                  String
  description           String?
  mainCategoryId        String?
  // Coordinates of the place. Decimal for accuracy
  lat                   Decimal                @db.Decimal(10, 7)
  lng                   Decimal                @db.Decimal(10, 7)
  address               String?
  venueType             VenueType?
  priceTier             PriceTier?
  openingHours          Json? // normalized opening hours; if null -> assumed always open
  attributes            Json? // extra structured attributes
  rating                Float? // aggregated rating
  reviewCount           Int                    @default(0)
  isActive              Boolean                @default(true)
  moderation            ModerationStatus       @default(APPROVED)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  tags                  String[]
  city                  City                   @relation(fields: [cityId], references: [id])
  mainCategory          PlaceCategory?         @relation(fields: [mainCategoryId], references: [id])
  categories            PlaceToCategory[]
  sources               PlaceSource[]
  events                EventOccurrence[] // occurrences referencing this place
  reviews               Review[]
  favorites             Favorite[]
  planItems             PlanItem[]
  moderationEntries     ModerationEntry[]
  recommendationSignals RecommendationSignal[]

  @@index([cityId])
  @@index([lat, lng])
  @@index([mainCategoryId])
}

model Event {
  id             String           @id @default(cuid())
  cityId         String
  title          String
  description    String?
  mainCategoryId String?
  venueType      VenueType?
  priceTier      PriceTier?
  attributes     Json?
  imageUrl       String?
  rating         Float?
  reviewCount    Int              @default(0)
  isActive       Boolean          @default(true)
  moderation     ModerationStatus @default(APPROVED)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  city                  City                   @relation(fields: [cityId], references: [id])
  mainCategory          EventCategory?         @relation(fields: [mainCategoryId], references: [id])
  categories            EventToCategory[]
  occurrences           EventOccurrence[]
  sources               EventSource[]
  reviews               Review[]
  favorites             Favorite[]
  moderationEntries     ModerationEntry[]
  recommendationSignals RecommendationSignal[]

  @@index([cityId])
  @@index([mainCategoryId])
}

/// One event may have multiple occurrences in time and location
model EventOccurrence {
  id        String    @id @default(cuid())
  eventId   String
  placeId   String?
  // Either linked place or explicit coordinates
  lat       Decimal?  @db.Decimal(10, 7)
  lng       Decimal?  @db.Decimal(10, 7)
  startTime DateTime
  endTime   DateTime?
  timezone  String?
  url       String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  event     Event      @relation(fields: [eventId], references: [id])
  place     Place?     @relation(fields: [placeId], references: [id])
  planItems PlanItem[]

  @@index([eventId])
  @@index([placeId])
  @@index([startTime])
  @@index([lat, lng])
}

model PlaceToCategory {
  placeId    String
  categoryId String
  isPrimary  Boolean @default(false)

  place    Place         @relation(fields: [placeId], references: [id])
  category PlaceCategory @relation(fields: [categoryId], references: [id])

  @@id([placeId, categoryId])
}

model EventToCategory {
  eventId    String
  categoryId String
  isPrimary  Boolean @default(false)

  event    Event         @relation(fields: [eventId], references: [id])
  category EventCategory @relation(fields: [categoryId], references: [id])

  @@id([eventId, categoryId])
}

// ---------
// External sources mapping
// ---------

model PlaceSource {
  id         String     @id @default(cuid())
  placeId    String
  source     SourceType
  externalId String
  url        String?
  payload    Json? // raw/normalized snapshot
  fetchedAt  DateTime?
  createdAt  DateTime   @default(now())

  place Place @relation(fields: [placeId], references: [id])

  @@unique([source, externalId])
  @@index([placeId])
}

model EventSource {
  id         String     @id @default(cuid())
  eventId    String
  source     SourceType
  externalId String
  url        String?
  payload    Json?
  fetchedAt  DateTime?
  createdAt  DateTime   @default(now())

  event Event @relation(fields: [eventId], references: [id])

  @@unique([source, externalId])
  @@index([eventId])
}

// ---------
// User content: Plans, Favorites, Reviews
// ---------

model Plan {
  id        String    @id @default(cuid())
  userId    String
  cityId    String?
  title     String
  date      DateTime?
  isShared  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user  User       @relation(fields: [userId], references: [id])
  city  City?      @relation(fields: [cityId], references: [id])
  items PlanItem[]
}

model PlanItem {
  id           String    @id @default(cuid())
  planId       String
  // Reference either a place or an event occurrence
  placeId      String?
  occurrenceId String?
  orderIndex   Int       @default(0)
  notes        String?
  startAt      DateTime?
  endAt        DateTime?

  plan       Plan             @relation(fields: [planId], references: [id])
  place      Place?           @relation(fields: [placeId], references: [id])
  occurrence EventOccurrence? @relation(fields: [occurrenceId], references: [id])

  @@index([planId])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  placeId   String?
  eventId   String?
  createdAt DateTime @default(now())

  user  User   @relation(fields: [userId], references: [id])
  place Place? @relation(fields: [placeId], references: [id])
  event Event? @relation(fields: [eventId], references: [id])

  @@unique([userId, placeId], map: "uniq_fav_place")
  @@unique([userId, eventId], map: "uniq_fav_event")
}

model Review {
  id        String           @id @default(cuid())
  userId    String
  placeId   String?
  eventId   String?
  rating    Int
  text      String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  status    ModerationStatus @default(PENDING)

  user        User              @relation(fields: [userId], references: [id])
  place       Place?            @relation(fields: [placeId], references: [id])
  event       Event?            @relation(fields: [eventId], references: [id])
  moderations ModerationEntry[]

  @@index([placeId])
  @@index([eventId])
}

// ---------
// Partners, Imports, Moderation, Recommendations
// ---------

model Partner {
  id           String   @id @default(cuid())
  name         String
  contactEmail String?
  cityId       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  city    City?       @relation(fields: [cityId], references: [id])
  imports ImportJob[]
}

model ImportJob {
  id         String      @id @default(cuid())
  partnerId  String?
  kind       ImportKind
  source     SourceType?
  url        String?
  payload    Json?
  startedAt  DateTime    @default(now())
  finishedAt DateTime?
  status     String      @default("pending") // textual status + details in log
  log        Json?

  partner Partner? @relation(fields: [partnerId], references: [id])
}

/// Moderation entries for any content (place, event, review)
model ModerationEntry {
  id        String           @id @default(cuid())
  status    ModerationStatus @default(PENDING)
  reason    String?
  notes     String?
  placeId   String?
  eventId   String?
  reviewId  String?
  createdAt DateTime         @default(now())
  decidedAt DateTime?

  place  Place?  @relation(fields: [placeId], references: [id])
  event  Event?  @relation(fields: [eventId], references: [id])
  review Review? @relation(fields: [reviewId], references: [id])
}

/// Aggregated recommendation signals stored for experimentation
model RecommendationSignal {
  id        String   @id @default(cuid())
  placeId   String?
  eventId   String?
  signals   Json // arbitrary features: popularity, freshness, distance buckets, etc.
  score     Float? // precomputed score
  updatedAt DateTime @updatedAt

  place Place? @relation(fields: [placeId], references: [id])
  event Event? @relation(fields: [eventId], references: [id])

  @@unique([placeId], map: "uniq_signal_place")
  @@unique([eventId], map: "uniq_signal_event")
}
